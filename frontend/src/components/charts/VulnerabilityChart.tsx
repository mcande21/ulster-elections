import { useRef } from 'react';
import { Card } from 'antd';
import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } from 'recharts';
import type { VulnerabilityScore } from '../../types';
import { ExportButton } from '../ExportButton';

interface VulnerabilityChartProps {
  races: VulnerabilityScore[];
  onRaceClick?: (race: VulnerabilityScore) => void;
  maxRaces?: number;
}

const truncate = (str: string, max: number) =>
  str.length > max ? str.slice(0, max) + '...' : str;

export const VulnerabilityChart = ({
  races,
  onRaceClick,
  maxRaces = 15,
}: VulnerabilityChartProps) => {
  const chartRef = useRef<HTMLDivElement>(null);

  // Sort by vulnerability score descending and limit to maxRaces
  const topRaces = [...races]
    .sort((a, b) => b.vulnerability_score - a.vulnerability_score)
    .slice(0, maxRaces);

  // Prepare chart data
  const data = topRaces.map((race) => ({
    name: race.race_title,
    score: race.vulnerability_score,
    margin: race.margin_pct,
    category: race.category,
    race, // Keep reference for onClick handler
  }));

  const handleBarClick = (entry: any) => {
    if (onRaceClick && entry?.race) {
      onRaceClick(entry.race);
    }
  };


  return (
    <Card
      title="Vulnerability by Race"
      variant="borderless"
      extra={
        <ExportButton
          type="png"
          elementRef={chartRef}
          filename="vulnerability-chart"
        />
      }
    >
      <div ref={chartRef}>
        <ResponsiveContainer width="100%" height={Math.max(400, topRaces.length * 35)}>
          <BarChart
            data={data}
            layout="vertical"
            margin={{ top: 5, right: 80, left: 150, bottom: 5 }}
          >
            <CartesianGrid strokeDasharray="3 3" />
            <XAxis type="number" domain={[0, 100]} />
            <YAxis
              type="category"
              dataKey="name"
              width={180}
              tick={{ fontSize: 11 }}
              tickFormatter={(value) => truncate(value, 30)}
            />
            <Tooltip
              formatter={(value: any, name: string | undefined) => {
                if (name === 'score') return [`${value.toFixed(1)}`, 'Vulnerability Score'];
                return [value, name];
              }}
              labelFormatter={(label) => String(label)}
              contentStyle={{ fontSize: 12 }}
            />
            <Bar
              dataKey="score"
              onClick={handleBarClick}
              cursor="pointer"
              fill="#1890ff"
            />
          </BarChart>
        </ResponsiveContainer>
      </div>
    </Card>
  );
};
