import React, { useEffect, useState } from 'react';
import { Card, Table, Tag, Alert, Tooltip } from 'antd';
import { InfoCircleOutlined } from '@ant-design/icons';
import type { VulnerabilityScore } from '../types';
import { getVulnerabilityScores } from '../api/client';

interface VulnerabilityPanelProps {
  filters?: {
    county?: string[];
    party?: string[];
    competitiveness?: string[];
    raceType?: string[];
  };
}

export const VulnerabilityPanel: React.FC<VulnerabilityPanelProps> = ({ filters }) => {
  const [data, setData] = useState<VulnerabilityScore[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(false);

  useEffect(() => {
    setLoading(true);
    setError(false);
    getVulnerabilityScores(20, filters)
      .then(setData)
      .catch(() => setError(true))
      .finally(() => setLoading(false));
  }, [filters]);

  const columns = [
    {
      title: (
        <Tooltip title="Vulnerability Score (0-100): Combines margin tightness (35%), swing potential (25%), turnout volatility (15%), undervote rate (15%), and party category (10%). Higher = more competitive.">
          Score <InfoCircleOutlined style={{ marginLeft: 4, color: '#999' }} />
        </Tooltip>
      ),
      dataIndex: 'vulnerability_score',
      key: 'score',
      render: (score: number) => <strong>{score.toFixed(1)}</strong>,
      width: 70,
    },
    {
      title: 'Category',
      dataIndex: 'category',
      key: 'category',
      render: (cat: string) => (
        <Tag color={cat === 'flip_opportunity' ? 'blue' : cat === 'retention_risk' ? 'orange' : 'default'}>
          {cat === 'flip_opportunity' ? 'Flip' : cat === 'retention_risk' ? 'Retain' : 'Other'}
        </Tag>
      ),
      width: 80,
    },
    {
      title: 'Race',
      dataIndex: 'race_title',
      key: 'race',
      ellipsis: true,
    },
    {
      title: 'County',
      dataIndex: 'county',
      key: 'county',
      width: 100,
    },
    {
      title: 'Margin',
      dataIndex: 'margin_pct',
      key: 'margin',
      render: (pct: number) => `${pct.toFixed(1)}%`,
      width: 80,
    },
  ];

  if (error) {
    return (
      <Card title="Most Vulnerable Races" style={{ marginBottom: 16 }}>
        <Alert description="Failed to load vulnerability data" type="error" showIcon />
      </Card>
    );
  }

  return (
    <Card title="Most Vulnerable Races" style={{ marginBottom: 16 }}>
      <Table
        columns={columns}
        dataSource={data}
        rowKey="id"
        loading={loading}
        pagination={false}
        size="small"
      />
    </Card>
  );
};

export default VulnerabilityPanel;
