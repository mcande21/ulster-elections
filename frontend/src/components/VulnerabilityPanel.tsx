import React, { useState } from 'react';
import { Card, Table, Tag, Tooltip } from 'antd';
import { InfoCircleOutlined } from '@ant-design/icons';
import type { TablePaginationConfig } from 'antd/es/table';
import type { VulnerabilityScore } from '../types';
import { ExportButton } from './ExportButton';

interface VulnerabilityPanelProps {
  data: VulnerabilityScore[];
  loading?: boolean;
}

export const VulnerabilityPanel: React.FC<VulnerabilityPanelProps> = ({ data, loading = false }) => {
  const [pagination, setPagination] = useState<TablePaginationConfig>({
    current: 1,
    pageSize: 20,
    showSizeChanger: true,
    pageSizeOptions: ['10', '20', '50', '100'],
    showTotal: (total) => `Total ${total} races`,
  });

  const columns = [
    {
      title: (
        <Tooltip title="Vulnerability Score (0-100): Combines margin tightness (35%), swing potential (25%), turnout volatility (15%), undervote rate (15%), and party category (10%). Higher = more competitive.">
          <span style={{ whiteSpace: 'nowrap' }}>
            Score <InfoCircleOutlined style={{ marginLeft: 4, color: '#999' }} />
          </span>
        </Tooltip>
      ),
      dataIndex: 'vulnerability_score',
      key: 'score',
      render: (score: number) => <strong>{score.toFixed(1)}</strong>,
      width: 100,
      sorter: (a: VulnerabilityScore, b: VulnerabilityScore) => b.vulnerability_score - a.vulnerability_score,
      defaultSortOrder: 'descend' as const,
    },
    {
      title: <span style={{ whiteSpace: 'nowrap' }}>Category</span>,
      dataIndex: 'category',
      key: 'category',
      render: (cat: string) => (
        <Tag color={cat === 'flip_opportunity' ? 'blue' : cat === 'retention_risk' ? 'orange' : 'default'}>
          {cat === 'flip_opportunity' ? 'Flip' : cat === 'retention_risk' ? 'Retain' : 'Other'}
        </Tag>
      ),
      width: 100,
      filters: [
        { text: 'Flip Opportunity', value: 'flip_opportunity' },
        { text: 'Retention Risk', value: 'retention_risk' },
      ],
      onFilter: (value: unknown, record: VulnerabilityScore) => record.category === String(value),
    },
    {
      title: 'Race',
      dataIndex: 'race_title',
      key: 'race',
      ellipsis: true,
    },
    {
      title: <span style={{ whiteSpace: 'nowrap' }}>County</span>,
      dataIndex: 'county',
      key: 'county',
      width: 110,
    },
    {
      title: 'Margin',
      dataIndex: 'margin_pct',
      key: 'margin',
      render: (pct: number) => `${pct.toFixed(1)}%`,
      width: 80,
      sorter: (a: VulnerabilityScore, b: VulnerabilityScore) => a.margin_pct - b.margin_pct,
    },
  ];

  const handleTableChange = (newPagination: TablePaginationConfig) => {
    setPagination(newPagination);
  };

  return (
    <Card
      title="Most Vulnerable Races"
      style={{ marginBottom: 16 }}
      extra={
        <ExportButton
          type="csv"
          data={data}
          columns={[
            { key: 'vulnerability_score', header: 'Score' },
            { key: 'category', header: 'Category' },
            { key: 'race_title', header: 'Race' },
            { key: 'county', header: 'County' },
            { key: 'margin_pct', header: 'Margin %' },
          ]}
          filename="vulnerability-races"
        />
      }
    >
      <Table
        columns={columns}
        dataSource={data}
        rowKey="id"
        loading={loading}
        pagination={pagination}
        size="small"
        onChange={handleTableChange}
      />
    </Card>
  );
};

export default VulnerabilityPanel;
